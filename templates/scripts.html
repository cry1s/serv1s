<!doctype html>
<html>
<head>
    <title>Script Runner</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container">
    <div class="left-section">
        <h1>Run a Script</h1>
        <input type="text" id="search" placeholder="Search for scripts...">
        <table id="scriptTable">
            <thead>
                <tr>
                    <th>Script</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for script in scripts %}
                <tr>
                    <td>{{ script }}</td>
                    <td><button onclick="loadScriptParams('{{ script }}')">Run</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div id="scriptParams" style="display: none;">
            <h2>Parameters for <span id="selectedScript"></span></h2>
            <form id="runScriptForm">
                <input type="hidden" name="script_name" id="script_name">
                <input type="hidden" name="env_vars" id="env_vars">
                
                <div id="envVars">
                    <label>Environment Variables:</label>
                </div>
                
                <button type="button" onclick="startScript()">Execute</button>
            </form>
        </div>
    </div>

    <div class="output-section">
        <h2>Output:</h2>
        <pre id="output"></pre>
    </div>
</div>

<script>
    function loadScriptParams(script) {
        $('#selectedScript').text(script);
        $('#script_name').val(script);
        $('#scriptParams').show();
        
        $.getJSON(`/scripts/${script}`, function(envVars) {
            $('#envVars').empty();
            $.each(envVars, function(key, value) {
                $('#envVars').append(`
                    <div>
                        <label>${key}:</label>
                        <input type="text" name="env_var_${key}" value="${value}">
                    </div>
                `);
            });
        });
    }

    function startScript() {
        let script_name = encodeURIComponent($('#script_name').val());
        let params = encodeURIComponent($('#params').val());
        let envVars = {};

        $('#envVars input[type="text"]').each(function() {
            let input = $(this);
            let name = input.attr('name');
            if (name?.startsWith("env_var_")) {
                let key = name.replace("env_var_", "");
                envVars[key] = input.val();
            }
        });

        $('#output').empty();
        let source = new EventSource(`/run_script?script_name=${script_name}&params=${params}&env_vars=${encodeURIComponent(JSON.stringify(envVars))}`);

        source.onmessage = function(event) {
            $('#output').append(event.data + "\n");
        };

        source.onerror = function() {
            source.close();
        };
    }

    $('#search').on('keyup', function() {
        var value = $(this).val().toLowerCase();
        $("#scriptTable tbody tr").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });
</script>
</body>
</html>
